<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kích hoạt bản quyền | LicSys Demo</title>
<style>
  :root{
    --bg: #0f1226;
    --card: rgba(255,255,255,0.08);
    --card-strong: rgba(255,255,255,0.12);
    --text: #eef2ff;
    --muted: #c7cbe6;
    --primary: #7c5cff;
    --primary-2: #3dd9eb;
    --success: #42d392;
    --danger: #ff5c7c;
    --warning: #f6c945;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 10% -10%, #2a1b64 0%, rgba(2,7,60,0) 60%),
      radial-gradient(900px 500px at 110% 30%, #0b6672 0%, rgba(11,102,114,0) 60%),
      linear-gradient(180deg, #0b0d1f 0%, #0f1226 70%);
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .wrap{width:100%; max-width:980px}
  header{display:flex; align-items:center; justify-content:space-between; margin-bottom:16px}
  .logo{
    display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px
  }
  .logo .mark{
    width:36px; height:36px; border-radius:12px; background:
      conic-gradient(from 180deg at 50% 50%, var(--primary), var(--primary-2));
    box-shadow: 0 6px 20px rgba(124,92,255,.4), 0 2px 6px rgba(61,217,235,.25);
  }
  .subtle a{color:var(--muted); text-decoration:none}
  .grid{
    display:grid; grid-template-columns:1.1fr .9fr; gap:18px;
  }
  @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

  .card{
    background: var(--card);
    border: 1px solid rgba(255,255,255,.08);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 18px;
    backdrop-filter: blur(10px);
  }
  .card h2{margin:0 0 12px 0; font-size:20px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .input, .select{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06); color:var(--text); outline:none;
  }
  .btn{
    appearance:none; border:none; border-radius:12px; padding:12px 16px;
    background: linear-gradient(135deg, var(--primary), var(--primary-2));
    color:#0b0d1f; font-weight:700; cursor:pointer; transition:.15s transform ease, .2s filter ease;
    box-shadow: 0 8px 24px rgba(124,92,255,.35), inset 0 0 0 1px rgba(255,255,255,.2);
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.ghost{
    background: transparent; color: var(--text); border:1px dashed rgba(255,255,255,.25);
    box-shadow:none; font-weight:600;
  }
  .btn.warn{background: linear-gradient(135deg, #ff7a7a, #ffb86c); color:#1a0f18}
  .kpi{
    display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px
  }
  .kpi .item{
    background: var(--card-strong); border: 1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px
  }
  .badge{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
    background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.1)
  }
  .badge.s{background: rgba(66,211,146,.12); color:#b8f5d6; border-color: rgba(66,211,146,.35)}
  .badge.w{background: rgba(246,201,69,.12); color:#ffe8a6; border-color: rgba(246,201,69,.35)}
  .badge.d{background: rgba(255,92,124,.12); color:#ffc2cf; border-color: rgba(255,92,124,.35)}
  .help{font-size:13px; margin-top:8px}
  .hidden{display:none !important}
  .toast{
    position:fixed; right:16px; bottom:16px; min-width:240px; max-width: 360px; z-index:10;
    background:#121632; color:#eaf2ff; border:1px solid rgba(255,255,255,.15); border-radius:14px; padding:12px 14px; box-shadow: var(--shadow);
    transform: translateY(20px); opacity:0; pointer-events:none; transition: all .25s ease;
  }
  .toast.show{transform: translateY(0); opacity:1}
  footer{margin-top:18px; text-align:center; color:var(--muted); font-size:13px}
  code.inline{background: rgba(255,255,255,.08); padding:2px 6px; border-radius:6px}
  .mini{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"><div class="mark"></div><div>LicSys <span class="muted">Demo</span></div></div>
    <div class="subtle"><a href="admin.html" aria-label="Mở trang quản trị">Trang quản trị →</a></div>
  </header>

  <div class="grid">
    <!-- Device card -->
    <section class="card">
      <h2>Thiết bị của bạn</h2>
      <div class="muted">Hãy sao chép <strong>Device ID</strong> và gửi cho admin để được thêm vào key.</div>
      <div class="row" style="margin-top:12px">
        <input id="deviceId" class="input mono" readonly aria-label="Device ID">
        <button class="btn" id="copyDeviceBtn">Sao chép ID</button>
      </div>
      <div class="help mini">Nếu admin chưa thêm ID này vào key, bạn sẽ không kích hoạt được.</div>
    </section>

    <!-- Activation / License card -->
    <section class="card" id="activationCard">
      <h2>Trạng thái bản quyền</h2>

      <!-- Form kích hoạt -->
      <div id="formView">
        <div class="muted">Nhập <strong>Key kích hoạt</strong> được cấp từ <code class="inline">admin.html</code> để mở khoá sử dụng.</div>
        <div class="row" style="margin-top:12px">
          <input id="licenseInput" class="input mono" placeholder="VD: ABCD-EFGH-1234" autocomplete="one-time-code" aria-label="Nhập key kích hoạt">
          <button class="btn" id="activateBtn">Kích hoạt</button>
        </div>
        <div class="help mini">Chưa có key? Gửi Device ID cho admin để được cấp.</div>
      </div>

      <!-- Đã kích hoạt -->
      <div id="activeView" class="hidden">
        <div class="row" style="justify-content:space-between">
          <div class="badge" id="statusBadge"><span>Đang kiểm tra…</span></div>
          <button class="btn ghost" id="refreshBtn">Làm mới</button>
        </div>

        <div class="kpi">
          <div class="item">
            <div class="muted mini">Người dùng</div>
            <div id="userName" style="font-weight:700; margin-top:4px">—</div>
          </div>
          <div class="item">
            <div class="muted mini">Mã kích hoạt</div>
            <div class="row" style="margin-top:4px; justify-content:space-between">
              <div class="mono" id="keyCode">—</div>
              <button class="btn ghost" id="copyKeyBtn" title="Sao chép key">Copy</button>
            </div>
          </div>
          <div class="item">
            <div class="muted mini">Thời gian còn lại</div>
            <div id="remaining" style="font-weight:700; margin-top:4px">—</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="muted mini">Hết hạn lúc: <span id="expiresAt">—</span></div>
        </div>

        <div class="row" style="margin-top:14px; justify-content:flex-end; gap:10px">
          <button class="btn warn" id="deactivateBtn" title="Thoát bản quyền trên thiết bị này">Đăng xuất</button>
        </div>
      </div>
    </section>
  </div>

  <footer>
    © <span id="year"></span> LicSys Demo • Lưu ý: dữ liệu lưu trên <strong>localStorage</strong> (demo).
  </footer>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
/* ===========================
   LicSys DEMO (Client-only)
   - Lưu trữ bằng localStorage
   - Không dùng server
   =========================== */

const LS_KEYS = {
  KEYS_DB: 'licsys_keys',
  ADMIN_DB: 'licsys_admin',
  DEVICE_ID: 'licsys_device_id',
  ACTIVE_SESSION: 'licsys_active_session'
};

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

const Toast = {
  t: null,
  show(msg){
    const el = $('#toast');
    el.textContent = msg;
    el.classList.add('show');
    clearTimeout(this.t);
    this.t = setTimeout(()=>el.classList.remove('show'), 2500);
  }
};

function uuidv4(){
  // RFC4122 v4
  const buf = new Uint8Array(16);
  (window.crypto||window.msCrypto).getRandomValues(buf);
  buf[6] = (buf[6] & 0x0f) | 0x40;
  buf[8] = (buf[8] & 0x3f) | 0x80;
  const bth = [...buf].map(b => b.toString(16).padStart(2,'0')).join('');
  return `${bth.substr(0,8)}-${bth.substr(8,4)}-${bth.substr(12,4)}-${bth.substr(16,4)}-${bth.substr(20)}`;
}

function getDeviceId(){
  let id = localStorage.getItem(LS_KEYS.DEVICE_ID);
  if(!id){ id = uuidv4(); localStorage.setItem(LS_KEYS.DEVICE_ID, id); }
  return id;
}

function copyToClipboard(text){
  if(navigator.clipboard && window.isSecureContext){
    return navigator.clipboard.writeText(text).then(()=>true).catch(()=>false);
  }else{
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); ta.setSelectionRange(0, text.length);
    let ok=false; try{ ok=document.execCommand('copy'); }catch(_){}
    document.body.removeChild(ta);
    return Promise.resolve(ok);
  }
}

function readKeys(){
  try{
    return JSON.parse(localStorage.getItem(LS_KEYS.KEYS_DB) || '[]');
  }catch(e){ return []; }
}
function saveKeys(arr){
  localStorage.setItem(LS_KEYS.KEYS_DB, JSON.stringify(arr));
}

function getActiveSession(){
  try{
    return JSON.parse(localStorage.getItem(LS_KEYS.ACTIVE_SESSION) || 'null');
  }catch(e){ return null; }
}
function setActiveSession(obj){
  if(obj) localStorage.setItem(LS_KEYS.ACTIVE_SESSION, JSON.stringify(obj));
  else localStorage.removeItem(LS_KEYS.ACTIVE_SESSION);
}

function findKeyById(id){ return readKeys().find(k=>k.id===id); }
function findKeyByCode(code){
  if(!code) return null;
  const norm = code.toUpperCase().replace(/[^A-Z0-9]/g,'');
  return readKeys().find(k => k.code.replace(/[^A-Z0-9]/g,'') === norm);
}

function computeStatus(key){
  const now = Date.now();
  if(!key) return {label:'Không tìm thấy', cls:'d'};
  if(now >= key.expiresAt) return {label:'Hết hạn', cls:'d'};
  const activeCount = Array.isArray(key.devicesActive) ? key.devicesActive.length : 0;
  return activeCount > 0 ? {label:'Đang hoạt động', cls:'s'} : {label:'Chưa kích hoạt', cls:'w'};
}

function fmtDT(ts){
  try{
    return new Date(ts).toLocaleString();
  }catch(_){ return '—'; }
}
function fmtRemain(ms){
  if(ms<=0) return '0 giây';
  const s = Math.floor(ms/1000);
  const d = Math.floor(s/86400);
  const h = Math.floor((s%86400)/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  const parts = [];
  if(d) parts.push(`${d} ngày`);
  if(h||d) parts.push(`${h} giờ`);
  if(m||d||h) parts.push(`${m} phút`);
  parts.push(`${sec} giây`);
  return parts.join(' ');
}

function ensureDeviceOnActiveList(key, deviceId){
  if(!key.devicesActive) key.devicesActive = [];
  if(!key.devicesActive.includes(deviceId)){
    key.devicesActive.push(deviceId);
    const all = readKeys(); const idx = all.findIndex(k=>k.id===key.id);
    if(idx>-1){ all[idx]=key; saveKeys(all); }
  }
}

function removeDeviceFromActiveList(keyId, deviceId){
  const all = readKeys(); const idx = all.findIndex(k=>k.id===keyId);
  if(idx>-1){
    const k = all[idx];
    k.devicesActive = (k.devicesActive||[]).filter(d=>d!==deviceId);
    all[idx] = k; saveKeys(all);
  }
}

function refreshUI(){
  const deviceId = getDeviceId();
  $('#deviceId').value = deviceId;
  const session = getActiveSession();

  if(!session){
    // No session: show form
    $('#formView').classList.remove('hidden');
    $('#activeView').classList.add('hidden');
    return;
  }

  const key = findKeyById(session.keyId);
  // Mất key hoặc bị xoá
  if(!key){
    Toast.show('Key không còn tồn tại. Vui lòng kích hoạt lại.');
    setActiveSession(null);
    $('#formView').classList.remove('hidden');
    $('#activeView').classList.add('hidden');
    return;
  }

  // Kiểm tra hết hạn
  const now = Date.now();
  if(now >= key.expiresAt){
    Toast.show('Key đã hết hạn. Tự động đăng xuất.');
    removeDeviceFromActiveList(key.id, deviceId);
    setActiveSession(null);
    $('#formView').classList.remove('hidden');
    $('#activeView').classList.add('hidden');
    return;
  }

  // Kiểm tra thiết bị được phép
  const allowed = Array.isArray(key.devicesAllowed) ? key.devicesAllowed : [];
  if(!allowed.includes(deviceId)){
    Toast.show('Thiết bị này không còn được phép dùng key. Đăng xuất.');
    removeDeviceFromActiveList(key.id, deviceId);
    setActiveSession(null);
    $('#formView').classList.remove('hidden');
    $('#activeView').classList.add('hidden');
    return;
  }

  // OK: show active view
  ensureDeviceOnActiveList(key, deviceId);

  $('#formView').classList.add('hidden');
  $('#activeView').classList.remove('hidden');
  $('#userName').textContent = key.username || '—';
  $('#keyCode').textContent = key.code;
  $('#expiresAt').textContent = fmtDT(key.expiresAt);

  const st = computeStatus(key);
  const badge = $('#statusBadge');
  badge.classList.remove('s','w','d'); badge.classList.add(st.cls);
  badge.innerHTML = `<span>Trạng thái:</span> <strong>${st.label}</strong>`;

  const remain = key.expiresAt - now;
  $('#remaining').textContent = fmtRemain(remain);
}

function activateWithCode(){
  const codeRaw = $('#licenseInput').value.trim();
  if(!codeRaw){ Toast.show('Vui lòng nhập key.'); return; }
  const key = findKeyByCode(codeRaw);
  if(!key){ Toast.show('Key không hợp lệ.'); return; }

  const now = Date.now();
  if(now >= key.expiresAt){ Toast.show('Key đã hết hạn.'); return; }

  const deviceId = getDeviceId();
  const allowed = Array.isArray(key.devicesAllowed) ? key.devicesAllowed : [];
  if(!allowed.includes(deviceId)){
    Toast.show('Thiết bị chưa được admin thêm vào key.');
    return;
  }

  // Tạo session (gắn theo keyId để vẫn hợp lệ nếu admin reset mã key)
  const session = { keyId: key.id, deviceId, activatedAt: Date.now() };
  setActiveSession(session);

  ensureDeviceOnActiveList(key, deviceId);
  $('#licenseInput').value = '';
  Toast.show('Kích hoạt thành công!');
  refreshUI();
}

function deactivate(){
  const session = getActiveSession();
  if(session){
    removeDeviceFromActiveList(session.keyId, session.deviceId);
  }
  setActiveSession(null);
  Toast.show('Đã đăng xuất bản quyền.');
  refreshUI();
}

let ticker = null;
function startTicker(){
  if(ticker) clearInterval(ticker);
  ticker = setInterval(()=>{ refreshUI(); }, 1000);
}

function init(){
  $('#year').textContent = new Date().getFullYear();
  $('#deviceId').value = getDeviceId();

  $('#copyDeviceBtn').addEventListener('click', () => {
    copyToClipboard($('#deviceId').value).then(ok=>{
      Toast.show(ok ? 'Đã sao chép Device ID.' : 'Không thể sao chép.');
    });
  });
  $('#activateBtn').addEventListener('click', activateWithCode);
  $('#licenseInput').addEventListener('keydown', e=>{
    if(e.key==='Enter') activateWithCode();
  });
  $('#deactivateBtn').addEventListener('click', deactivate);
  $('#refreshBtn').addEventListener('click', refreshUI);
  $('#copyKeyBtn').addEventListener('click', ()=>{
    const t = $('#keyCode').textContent.trim();
    if(!t) return;
    copyToClipboard(t).then(ok=>Toast.show(ok?'Đã sao chép key.':'Không thể sao chép.'));
  });

  window.addEventListener('storage', (e)=>{
    // Các thay đổi từ admin.html (xoá/gia hạn/add thiết bị…) sẽ được phản ánh
    if(['licsys_keys'].includes(e.key)) refreshUI();
  });

  refreshUI();
  startTicker();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
